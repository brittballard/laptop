#!/bin/bash
# Add or update a Go dependency from import path `x` to `$PWD/vendor`.
# https://golang.org/cmd/go/#hdr-Vendor_Directories

set -eo pipefail

if [ "$#" -ne 1 ]; then
  echo "vendor a/go/package/import/path"
  exit 1
fi

if [ -d "$PWD/vendor/$1" ]; then
  COMMIT_MESSAGE="vendor: update $1"
  rm -rf "$PWD/vendor/$1"
else
  COMMIT_MESSAGE="vendor: add $1"
  mkdir -p "$PWD/vendor/$1"
fi

UPSTREAM_SHA=$(
  cd "$GOPATH/src/$1"
  git status | grep "working tree clean" > /dev/null
  git rev-parse HEAD
)

cp -r $(go list -f {{.Dir}} $1) "$PWD/vendor/$1"
rm -rf "$PWD/vendor/$1/.git"

printf "%s\\n\\nUpstream SHA %s\\n" "$COMMIT_MESSAGE" "$UPSTREAM_SHA"
